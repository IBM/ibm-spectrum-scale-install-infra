---
# tasks file for remote_mount

- name: precheck
  include_tasks: precheck.yml

- name: "Client Cluster (access) | Check if the '{{ client_cluster_filesystem_name }}' is already configured."
  uri:
    validate_certs: no
    force_basic_auth: yes
    url: https://{{ client_cluster_gui_hostname }}:{{ client_cluster_gui_port }}/{{ remote_mount_endpoint }}/remotefilesystems/{{ client_cluster_filesystem_name }}
    method: GET
    user: "{{ client_cluster_gui_username }}"
    password: "{{ client_cluster_gui_password }}"
    body_format: json
    status_code:
      - 400
  register: remote_filesystem_results
  ignore_errors: true

- block:
    - name: "Unauthorized"
      debug:
        msg: "The user is not authorized to access the Client Cluster, http return code: {{ remote_filesystem_results.status }}"

    - meta: end_play
  when:
    - remote_filesystem_results.status == 401

- name: msg
  debug:
    msg: "Force Run was passed in, attempting to run remote_mount role regardless of whether the filesystem is configured."
  when: forceRun | bool

- block:
    - name: "If filesystem is already configured, nothing to do."
      debug:
        msg: "Filesystem '{{ client_cluster_filesystem_name }}' is already configured, nothing to do."

    - meta: end_play
  when:
    - remote_filesystem_results.status == 200
    - not forceRun | bool

- name: Remote mount the filesystem when it's not already mounted
  include_tasks: mount_filesystem.yml
  when:
    - (remote_filesystem_results.status == 400) or (forceRun | bool)
