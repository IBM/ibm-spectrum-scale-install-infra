---
# YUM repository installation method

#
# Configure YUM repository
#
- name: Initialize
  set_fact:
   zimon_url: ""

- name: install | zimon path
  set_fact:
    zimon_url: 'zimon_rpms/rhel7/'
  when: ansible_distribution == 'RedHat' and ansible_distribution_major_version == '7'

- name: install | zimon path
  set_fact:
    zimon_url: 'zimon_rpms/rhel8/'
  when: ansible_distribution in scale_rhel_distribution and ansible_distribution_major_version == '8'

- name: install | zimon path
  set_fact:
    zimon_url: 'zimon_debs/ubuntu/ubuntu16/'
  when: ansible_distribution in scale_ubuntu_distribution and ansible_distribution_major_version == '16'

- name: install | zimon path
  set_fact:
    zimon_url: 'zimon_debs/ubuntu/ubuntu18/'
  when: ansible_distribution in scale_ubuntu_distribution and ansible_distribution_major_version == '18'

- name: install | zimon path
  set_fact:
    zimon_url: 'zimon_rpms/sles12/'
  when: ansible_distribution == 'SLES' and ansible_distribution_major_version == '12'

- name: install | zimon path
  set_fact:
    zimon_url: 'zimon_rpms/sles15/'
  when: ansible_distribution in scale_sles_distribution and ansible_distribution_major_version == '15'

- name: Initialize
  set_fact:
   gpgcheck: "yes"

- name: Disable gpg check
  set_fact:
   gpgcheck: "no"
  when: scale_version < '5.0.4.0'

- name: install | Configure ZIMon YUM repository
  yum_repository:
    name: spectrum-scale-zimon
    description: IBM Spectrum Scale (ZIMon)
    baseurl: "{{ scale_install_zimon_repository_url }}{{ zimon_url }}"
    gpgcheck: "{{ gpgcheck }}"
    repo_gpgcheck: no
    state: present
  notify: yum-clean-metadata
  when:
    - ansible_pkg_mgr == 'yum' or ansible_pkg_mgr == 'dnf'
    - scale_install_zimon_repository_url != 'existing'

- name: install | Configure zimon APT repository
  apt_repository:
    filename: spectrum-scale-zimon-debs
    repo: "deb [trusted=yes] {{ scale_install_zimon_repository_url }}{{ zimon_url }} ./"
    validate_certs: no
    state: present
    update_cache: yes
    codename: IBM Spectrum Scale (Zimon debs)
    mode: 0777
  when:
    - ansible_pkg_mgr == 'apt'
    - scale_install_repository_url != 'existing'

- debug:
        msg: "{{ scale_install_repository_url }}{{ zimon_url }}"

- name: install | Configure ZIMon repository
  zypper_repository:
    name: spectrum-scale-zimon
    description: IBM Spectrum Scale (ZIMon)
    repo: "{{ scale_install_repository_url }}{{ zimon_url }}"
    disable_gpg_check: no
    state: present
  when:
    - ansible_pkg_mgr == 'zypper'

- name: install | package methods
  set_fact:
    scale_zimon_sensors_packages: "{{ scale_zimon_sensors_packages }}"
    scale_zimon_collector_packages: "{{ scale_zimon_collector_packages }}"
  when: ansible_pkg_mgr == 'yum' or ansible_pkg_mgr == 'dnf' 

- name: install | package methods
  set_fact:
    scale_zimon_sensors_packages: "{{ scale_zimon_sensors_packages_ubuntu }}"
    scale_zimon_collector_packages: "{{ scale_zimon_collector_packages_ubuntu }}"
  when: ansible_pkg_mgr == 'apt'

- name: install | package methods
  set_fact:
    scale_zimon_sensors_packages: "{{ scale_zimon_sensors_packages_suse }}"
    scale_zimon_collector_packages: "{{ scale_zimon_collector_packages_suse }}"
  when: ansible_pkg_mgr == 'zypper'

#
# Add GUI packages
#
- name: install | Add GPFS sensors packages to list
  set_fact:
    scale_install_all_packages: "{{ scale_install_all_packages + [ item ] }}"
  with_items:
    - "{{ scale_zimon_sensors_packages }}"

- name: install | Add GPFS collector packages to list
  set_fact:
    scale_install_all_packages: "{{ scale_install_all_packages + [ item ] }}"
  with_items:
    - "{{ scale_zimon_collector_packages }}"
  when: (scale_zimon_collector | bool) or (scale_cluster_gui | bool)
