- block:
    - name: Ensure the file has 644 permissions
      file: 
        path: "{{ key_protect_dir }}/{{ resource_prefix }}.p12"
        mode: '0644'

    - name: Copy RKM.conf to destination
      template:
        src: "templates/RKM.conf.j2"
        dest: "{{ key_protect_dir }}/RKM.conf"
        owner: root
        group: root
        mode: '0600'

    - name: Fetch the p12 file from remote server
      fetch:
        src: "{{ key_protect_dir }}/{{ resource_prefix }}.p12"
        dest: "{{ key_protect_cert_files_dir }}"
        flat: yes

    - name: Fetch the RKM.conf file from remote server
      fetch:
        src: "{{ key_protect_dir }}/RKM.conf"
        dest: "{{ key_protect_cert_files_dir }}"
        flat: yes
  when: key_protect_dir is defined and key_protect_dir | length > 0