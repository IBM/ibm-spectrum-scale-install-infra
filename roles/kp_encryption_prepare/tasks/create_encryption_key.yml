- block:
    - name: Run mmgskkm store command
      command: mmgskkm store --pwd "{{ scale_encryption_admin_password }}" --label "{{ resource_prefix }}" --cert "{{ key_protect_dir }}/{{ resource_prefix }}.cert" --priv "{{ key_protect_dir }}/{{ resource_prefix }}.key" --out "{{ key_protect_dir }}/{{ resource_prefix }}.p12"
      args:
        chdir: "{{ key_protect_dir }}"

    - name: Run mmgskkm trust command
      command: mmgskkm trust --prefix "{{ key_protect_dir }}/Key_Protect_Server.chain" --pwd "{{ scale_encryption_admin_password }}" --label "{{ resource_prefix }}" --out "{{ key_protect_dir }}/{{ resource_prefix }}.p12"
      args:
        chdir: "{{ key_protect_dir }}"

    - name: Sleep for 20 seconds
      ansible.builtin.pause:
        seconds: 20

    - name: Run mmkmipkm createkey command
      command: >
        mmkmipkm createkey
        --host "{{ vpc_region }}.kms.cloud.ibm.com"
        --kmipport "{{ resource_prefix }}.port"
        --keystore "{{ resource_prefix }}.p12"
        --keypass "{{ resource_prefix }}.pwd"
        --label "{{ resource_prefix }}"
      args:
        chdir: "{{ key_protect_dir }}"
      register: createkey_output

    - name: Set encryption key fact
      set_fact:
        encryption_key: "{{ createkey_output.stdout }}"

    - name: Copy the Policy file
      template:
        src: "templates/KP.fsenc.pol.j2"
        dest: "/var/mmfs/etc/KP.fsenc.pol"
        owner: root
        group: root
        mode: '0600'
  when: key_protect_dir is defined and key_protect_dir | length > 0