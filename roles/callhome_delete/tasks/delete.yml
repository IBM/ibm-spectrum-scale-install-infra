- block:

  - name: check | Ensure callhome deletion is applicable
    assert:
      that:
        - scale_callhome_params.is_enabled is defined
        - not scale_callhome_params.is_enabled | bool
      fail_msg: "Callhome is still enabled. Skipping deletion."
      success_msg: "Callhome is disabled. Proceeding to delete callhome."
    when: ansible_hostname == scale_callhome_params.callhome_server

  - name: delete | Disable callhome capability
    shell: "{{ scale_command_path }}mmcallhome capability disable"
    register: scale_callhome_disable
    ignore_errors: true
    when: ansible_hostname == scale_callhome_params.callhome_server

  - name: delete | Show output of disable capability
    debug:
      msg: "{{ scale_callhome_disable.stdout }}"
    when: scale_callhome_disable is defined and scale_callhome_disable.stdout is defined

  - name: delete | Get list of callhome groups
    shell: "{{ scale_command_path }}mmcallhome group list | awk 'NR>1 {print $1}'"
    register: scale_callhome_groups
    changed_when: false
    when: ansible_hostname == scale_callhome_params.callhome_server

  - name: delete | Remove each callhome group
    shell: "{{ scale_command_path }}mmcallhome group delete {{ item }}"
    with_items: "{{ scale_callhome_groups.stdout_lines }}"
    register: scale_callhome_group_delete
    ignore_errors: true
    when: ansible_hostname == scale_callhome_params.callhome_server and
          scale_callhome_groups.stdout_lines is defined and
          scale_callhome_groups.stdout_lines | length > 0

  - name: delete | Show output of group delete
    debug:
      msg: "{{ scale_callhome_group_delete.results | map(attribute='stdout') | list }}"
    when: scale_callhome_group_delete is defined

  - name: delete | Disable proxy (if configured)
    shell: "{{ scale_command_path }}mmcallhome proxy disable"
    register: scale_callhome_proxy_disable
    ignore_errors: true
    when: ansible_hostname == scale_callhome_params.callhome_server

  - name: delete | Show output of proxy disable
    debug:
      msg: "{{ scale_callhome_proxy_disable.stdout }}"
    when: scale_callhome_proxy_disable is defined and scale_callhome_proxy_disable.stdout is defined
