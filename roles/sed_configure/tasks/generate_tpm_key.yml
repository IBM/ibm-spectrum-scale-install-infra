---
# Generate only on one node. migrate to others. 
# Run both commands only on one single io node. 

- block:
    # Generate a TPM key 
    - name: Generate TPM key
      command: mmvdisk tpm genkey --nv-slot-id {{ nv_slot_id }} --password-file {{ tpm_password_file }}
      register: tpm_key_generate

    - debug:
        msg: "{{(tpm_key_generate.rc == 0) | ternary(tpm_key_generate.stdout.split('\n'),  tpm_key_generate.stderr.split('\n')) }}"
      failed_when: tpm_key_generate.rc != 0
  when: generate and inventory_hostname in hostvars[groups['emsvm'][0]]['scale_io_nodes_list']
  run_once: true
  
- block: 
    # Migrate the generated TPM key to other io nodes
    - name: Migrate TPM key to other nodes
      command: mmvdisk tpm migratekey --nv-slot-id {{ nv_slot_id }} -s {{ inventory_hostname }} -N {{ target_nodes | join(',') }}
      vars: 
          target_nodes: "{{ (hostvars[groups['emsvm'][0]]['scale_io_nodes_list'])[1:]}}"
      register: tpm_key_migrate

    - debug:
        msg: "{{ (tpm_key_migrate.rc == 0) | ternary(tpm_key_migrate.stdout.split('\n'),tpm_key_migrate.stderr.split('\n')) }}"
      failed_when: tpm_key_migrate.rc != 0
  when: migrate and inventory_hostname in hostvars[groups['emsvm'][0]]['scale_io_nodes_list']
  run_once: true