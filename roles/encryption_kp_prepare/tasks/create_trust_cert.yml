# Server - 1
- block:
    - name: Create a folder
      file:
        path: "{{ key_protect_dir }}"
        state: directory

    - name: Append password to KPClient.pwd
      lineinfile:
        path: "{{ key_protect_dir }}/{{ resource_prefix }}.pwd"
        line: "{{ scale_encryption_admin_password }}"
        create: yes

    - name: Append port to kmip.port
      lineinfile:
        path: "{{ key_protect_dir }}/{{ resource_prefix }}.port"
        line: "{{ key_protect_port }}"
        create: yes

    - name: Copy files from source to destination folder
      copy:
        src: "{{ item }}"
        dest: "{{ key_protect_dir }}"
        owner: root
        group: root
      with_fileglob:
        - "/opt/IBM/ibm-spectrumscale-cloud-deploy/key_protect/*"

    - name: Run mmgskkm store command
      command: mmgskkm store --pwd "{{ scale_encryption_admin_password }}" --label "{{ resource_prefix }}" --cert "{{ key_protect_dir }}/{{ resource_prefix }}.cert" --priv "{{ key_protect_dir }}/{{ resource_prefix }}.key" --out "{{ key_protect_dir }}/{{ resource_prefix }}.p12"
      args:
        chdir: "{{ key_protect_dir }}"

    - name: Run mmgskkm trust command
      command: mmgskkm trust --prefix "{{ key_protect_dir }}/Key_Protect_Server.chain" --pwd "{{ scale_encryption_admin_password }}" --label "{{ resource_prefix }}" --out "{{ key_protect_dir }}/{{ resource_prefix }}.p12"
      args:
        chdir: "{{ key_protect_dir }}"

    - name: Sleep for 20 seconds
      ansible.builtin.pause:
        seconds: 20

    - name: Run mmkmipkm createkey command
      command: >
        mmkmipkm createkey
        --host "{{ vpc_region }}.kms.cloud.ibm.com"
        --kmipport "{{ resource_prefix }}.port"
        --keystore "{{ resource_prefix }}.p12"
        --keypass "{{ resource_prefix }}.pwd"
        --label "{{ resource_prefix }}"
      args:
        chdir: "{{ key_protect_dir }}"
      register: createkey_output

    - name: Set encryption key fact
      set_fact:
        encryption_key: "{{ createkey_output.stdout }}"

    - name: Ensure the file has 644 permissions
      file: 
        path: "{{ key_protect_dir }}/{{ resource_prefix }}.p12"
        mode: '0644'

    - name: Copy RKM.conf to destination
      template:
        src: "templates/RKM.conf.j2"
        dest: "{{ key_protect_dir }}/RKM.conf"
        owner: root
        group: root
        mode: '0600'

    - name: Copy the Policy file
      template:
        src: "templates/KP.fsenc.pol.j2"
        dest: "/var/mmfs/etc/KP.fsenc.pol"
        owner: root
        group: root
        mode: '0600'

    - name: Fetch the p12 file from remote server
      fetch:
        src: "{{ key_protect_dir }}/{{ resource_prefix }}.p12"
        dest: "/opt/IBM/ibm-spectrumscale-cloud-deploy/key_protect/"
        flat: yes

    - name: Fetch the RKM.conf file from remote server
      fetch:
        src: "{{ key_protect_dir }}/RKM.conf"
        dest: "/opt/IBM/ibm-spectrumscale-cloud-deploy/key_protect/"
        flat: yes

  when: key_protect_dir is defined and key_protect_dir | length > 0