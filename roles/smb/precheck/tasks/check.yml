---
- name: Initialize
  set_fact:
   smb_nodes_list: []

- name: Collect all smb nodes
  set_fact:
   smb_nodes_list: "{{ smb_nodes_list + [hostvars[item]['ansible_fqdn']] }}"
  when: hostvars[item]['is_protocol_node'] is defined and hostvars[item]['is_protocol_node']|bool
  with_items:
   - "{{ ansible_play_hosts }}"
  delegate_to: localhost
  run_once: true

- name: Check if atleast one smb node is configured
  assert:
   that:
   - smb_nodes_list|length > 0
   fail_msg: "No smb nodes configured"

- name: Check if smb is enabled
  assert:
   that:
   - protocols.smb|bool
   fail_msg: "SMB is not enabled"
  run_once: true

- name: Collect status of service smb
  shell:
   cmd: systemctl status smb
  register: smb_status
  ignore_errors: true

- name: Check if service smb is running
  assert:
   that:
   - smb_status.rc > 0
   fail_msg: "Service smb found running on {{ ansible_hostname }}. Which conflicts with the installation of SMB.SUGGESTTED ACTION- Run commands to stop (systemctl stop smb) and disable (systemctl disable smb) this service on node {{ ansible_hostname }}"
  when: ansible_fqdn in smb_nodes_list
  any_errors_fatal: true

- name: Collect status of service smbd
  shell:
   cmd: systemctl status smbd
  register: smb_status
  ignore_errors: true

- name: Check if service smbd is running
  assert:
   that:
   - smb_status.rc > 0
   fail_msg: "Service smbd found running on {{ ansible_hostname }} Which conflicts with the installation of SMB.
SUGGESTTED ACTION Run commands to stop (systemctl stop smbd) and disable (systemctl disable smbd) this service on node {{ ansible_hostname }}"
  when: ansible_fqdn in smb_nodes_list
  any_errors_fatal: true

- name: Collect status of service winbind
  shell:
   cmd: systemctl status winbind
  register: smb_status
  ignore_errors: true

- name: Check if service winbind is running
  assert:
   that:
   - smb_status.rc > 0
   fail_msg: "Service winbind found running on {{ ansible_hostname }}. Which conflicts with the installation of SMB.
SUGGESTTED ACTION Run commands to stop (systemctl stop winbind) and disable (systemctl disable winbind)
this service on node {{ ansible_hostname }}"
  when: ansible_fqdn in smb_nodes_list
  any_errors_fatal: true

- name: Collect status of service winbindd
  shell:
   cmd: systemctl status winbindd
  register: smb_status
  ignore_errors: true

- name: Check if service winbindd is running
  assert:
   that:
   - smb_status.rc > 0
   fail_msg: "Service winbindd found running on {{ ansible_hostname }}. Which conflicts with the installation of SMB.
SUGGESTTED ACTION Run commands to stop (systemctl stop winbindd) and disable (systemctl disable winbindd)
this service on node {{ ansible_hostname }}"
  when: ansible_fqdn in smb_nodes_list
  any_errors_fatal: true

- name: Collect status of service ctdb
  shell:
   cmd: systemctl status ctdb
  register: smb_status
  ignore_errors: true

- name: Check if service ctdb is running
  assert:
   that:
   - smb_status.rc > 0
   fail_msg: "Service ctdb found running on {{ ansible_hostname }}. Which conflicts with the installation of SMB.
SUGGESTTED ACTION Run commands to stop (systemctl stop ctdb) and disable (systemctl disable ctdb)
this service on node {{ ansible_hostname }}"
  when: ansible_fqdn in smb_nodes_list
  any_errors_fatal: true

- name: Collect status of service ctdbd
  shell:
   cmd: systemctl status ctdbd
  register: smb_status
  ignore_errors: true

- name: Check if service ctdbd is running
  assert:
   that:
   - smb_status.rc > 0
   fail_msg: "Service ctdbd found running on {{ ansible_hostname }}. Which conflicts with the installation of SMB.
SUGGESTTED ACTION Run commands to stop (systemctl stop ctdbd) and disable (systemctl disable ctdbd)
this service on node {{ ansible_hostname }}"
  when: ansible_fqdn in smb_nodes_list
  any_errors_fatal: true

- debug:
   msg: "SMB precheck ok"
