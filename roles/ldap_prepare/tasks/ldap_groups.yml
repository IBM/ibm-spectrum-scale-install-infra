---
# Creating LDAP Group on the LDAP Server

- name: Create ou.ldif file if it doesn't exist
  ansible.builtin.file:
    path: "{{ LDAP_DIR }}/group.ldif"
    state: touch

- name: LDAP | Group File
  ansible.builtin.blockinfile:
    path: "{{ LDAP_DIR }}/group.ldif"
    marker: "#Ansible Managed Content"
    block: |
      dn: cn={{ LDAP_GROUP }},ou=Groups,dc={{ BASE_DN.split('.')[0] }},dc={{ BASE_DN.split('.')[1] }}
      objectClass: posixGroup
      cn: {{ LDAP_GROUP }}
      gidNumber: 5000

- name: LDAP | Check Group Existence
  ansible.builtin.shell: |
    ldap_search_result=$(ldapsearch -x -D cn=admin,dc={{ BASE_DN.split('.')[0] }},dc={{ BASE_DN.split('.')[1] }} -w {{ LDAP_ADMIN_PASSWORD }} -b "ou=groups,dc={{ BASE_DN.split('.')[0] }},dc={{ BASE_DN.split('.')[1] }}" "(cn={{ LDAP_GROUP }})" 2>&1)
    if [[ "$ldap_search_result" == *"{{ LDAP_GROUP }}"* ]]; then
        echo "GroupFound"
    else
        echo "GroupNotFound"
    fi
  register: ldap_group_search

- name: LDAP | Group Created
  ansible.builtin.command: ldapadd -x -D cn=admin,dc={{ BASE_DN.split('.')[0] }},dc={{ BASE_DN.split('.')[1] }} -w {{ LDAP_ADMIN_PASSWORD }} -f {{ LDAP_DIR }}/group.ldif
  when: ldap_group_search.stdout == "GroupNotFound"
  notify: group_added

- name: LDAP | Group Exist
  debug:
    msg: "LDAP Group '{{ LDAP_GROUP }}' already exists. Skipping."
  when: ldap_group_search.stdout == "GroupFound"