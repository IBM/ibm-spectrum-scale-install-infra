---
# Creating Base OU for the LDAP Server

- name: LDAP | Server OU File
  ansible.builtin.blockinfile:
    path: "{{ LDAP_DIR }}/ou.ldif"
    marker: "#Ansible Managed Content"
    block: |
      dn: ou=People,dc={{ BASE_DN.split('.')[0] }},dc={{ BASE_DN.split('.')[1] }}
      objectClass: organizationalUnit
      ou: People
      
      dn: ou=Groups,dc={{ BASE_DN.split('.')[0] }},dc={{ BASE_DN.split('.')[1] }}
      objectClass: organizationalUnit
      ou: Groups

- name: LDAP | Server OU Update
  ansible.builtin.command: >
    ldapsearch -x -D cn=admin,dc={{ BASE_DN.split('.')[0] }},dc={{ BASE_DN.split('.')[1] }} -w {{ LDAP_ADMIN_PASSWORD }} -b "ou=People,dc={{ BASE_DN.split('.')[0] }},dc={{ BASE_DN.split('.')[1] }}" "(objectClass=organizationalUnit)"
  register: ldapousearch_result
  changed_when: false  

- name: LDAP | Server OU Create
  ansible.builtin.command: >
    ldapadd -x -D cn=admin,dc={{ BASE_DN.split('.')[0] }},dc={{ BASE_DN.split('.')[1] }} -w {{ LDAP_ADMIN_PASSWORD }} -f {{ LDAP_DIR }}/ou.ldif
  when: ldapousearch_result.rc != 0 

- debug:
    var: ldapouadd_result.stdout_lines