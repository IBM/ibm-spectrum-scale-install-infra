---
- name: configure | Initialize lists of AFM Nodes
  set_fact:
   scale_gateway_nodes: []

- name: cluster | Find AFM gateway nodes
  add_host:
    name: "{{ item }}"
    groups: scale_gateway_nodes
  when: hostvars[item].scale_cluster_gateway | bool
  with_items: "{{ ansible_play_hosts }}"
  changed_when: false

- name: configure | Setting AFM Sensors on AFM gateway nodes
  vars:
    # Extract short hostnames before the dot
    scale_gateway_node: >-
      {{ groups['scale_gateway_nodes'] | map('split', '.') | map('first') | list }}
  command: >-
    {{ scale_command_path }}mmperfmon config update
    GPFSAFMFS.restrict={{ scale_gateway_node | join(',') }}
    GPFSAFMFS.period=10
    GPFSAFMFSET.restrict={{ scale_gateway_node | join(',') }}
    GPFSAFMFS.period=10
    GPFSAFMFSET.restrict={{ scale_gateway_node | join(',') }}
    GPFSAFMFSET.period=10
    GPFSAFM.restrict={{ scale_gateway_node | join(',') }}
    GPFSAFM.period=10
  when: groups['scale_gateway_nodes'] | list | length > 0
  run_once: true