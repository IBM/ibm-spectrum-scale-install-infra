---
- name: delete | check server node
  add_host:
    name: "{{ hostvars[item]['ansible_fqdn'] }}"
    groups: scale_server_nodes
  when:
     - hostvars[item].state is defined and hostvars[item].state == 'absent'
     - (hostvars[item].is_nsd_server is defined and hostvars[item].is_nsd_server | bool)
  with_items: "{{ ansible_play_hosts }}"
  changed_when: false

- name: cluster | Find existing cluster
  shell: /usr/lpp/mmfs/bin/mmlscluster -Y | grep -v HEADER | grep clusterSummary | cut -d ':' -f 8
  register: scale_cluster_clusterId
  changed_when: false
  failed_when: false

- name: cluster | Find existing cluster members
  add_host:
    name: "{{ item }}"
    groups: scale_cluster_members
  when:
    - hostvars[item].state is defined and hostvars[item].state == 'present'
    - hostvars[item].scale_cluster_clusterId.stdout
  with_items: "{{ ansible_play_hosts }}"
  changed_when: false

- name: copy script
  copy:
    src: "remove_server.py"
    dest: "/root"
    mode: a+x
  delegate_to: "{{ groups['scale_cluster_members'].0 }}"

- name: run python
  command: /root/remove_server.py "{{ groups['scale_server_nodes'] | list | join(',') }}"
  delegate_to: "{{ groups['scale_cluster_members'].0 }}"
  when: groups['scale_server_nodes'] is defined and groups['scale_server_nodes'] | length > 0
  run_once: true
