---

- set_fact:
    scale_gpfs_smb_package: ''

- name: install | Get gpfs smb package
  yum:
    list: gpfs.smb.*
  register: package_name_version
  when:
    - ansible_pkg_mgr == 'yum' or ansible_pkg_mgr == 'dnf'

- name: install | Find GPFS SMB package
  vars:
    gpfs_smb_package: "{{ package_name_version.results|selectattr('yumstate','match','available')|map(attribute='version')|list }}"
  set_fact:
    scale_gpfs_smb_package: "{{ gpfs_smb_package | join('') }}"
  when:
    - ansible_pkg_mgr == 'yum' or ansible_pkg_mgr == 'dnf'

- name: upgrade | Check if gpfs smb package is installed
  shell: rpm -q gpfs.smb
  register: is_smb_package_installed
  failed_when: no
  changed_when: no
  when: ansible_pkg_mgr == 'yum' or ansible_pkg_mgr == 'dnf' or ansible_pkg_mgr == 'zypper'

- name: upgrade | Set if gpfs smb package is installed
  set_fact:
    is_scale_smb_pkg_downgrade: true
  when:
    - ansible_pkg_mgr == 'yum' or ansible_pkg_mgr == 'dnf' or ansible_pkg_mgr == 'zypper'
    - is_smb_package_installed.rc == 0
    - "'4.20' in is_smb_package_installed.stdout"
    - "'4.19' in scale_gpfs_smb_package"

- block:
    - name: upgrade | Upgrade GPFS SMB packages
      yum:
        name: "{{ scale_install_all_packages }}"
        state: latest
        update_only: yes
        disable_gpg_check: "{{ scale_disable_gpgcheck }}"
      register: package_up
      when: ansible_pkg_mgr == 'yum'

    - name: upgrade | Upgrade GPFS SMB packages
      package:
        name: "{{ scale_install_all_packages }}"
        state: latest
        disable_gpg_check: "{{ scale_disable_gpgcheck }}"
      when: ansible_distribution in scale_rhel_distribution and ansible_distribution_major_version >= '8'
  when:  is_scale_smb_pkg_downgrade is undefined


- block:
    - name: upgrade | Downgrade GPFS SMB packages
      yum:
       name: "gpfs.smb-4.19*"
       state: present
       disable_gpg_check: "{{ scale_disable_gpgcheck }}"
       allow_downgrade: true
      register: package_up_yum
      when: ansible_pkg_mgr == 'yum'

    - debug:
        msg: "{{package_up_yum}}"
      when: package_up_yum is defined

    - name: upgrade | Downgrade GPFS SMB packages
      package:
        name: "gpfs.smb-4.19*"
        state: present
        disable_gpg_check: "{{ scale_disable_gpgcheck }}"
        allow_downgrade: true
      register: package_up_pkg
      when: ansible_distribution in scale_rhel_distribution and ansible_distribution_major_version >= '8'

    - debug:
        msg: "{{package_up_pkg}}"
      when: package_up_pkg is defined

  when:  is_scale_smb_pkg_downgrade is defined     
