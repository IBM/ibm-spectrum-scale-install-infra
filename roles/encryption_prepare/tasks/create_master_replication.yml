#Setting up replication on the Master server

- name: "************************ Encryption | Master Replication | Login ************************"
  uri:
    url: "https://{{ scale_encryption_servers[0] }}:9443/SKLM/rest/v1/ckms/login"
    method: POST
    headers:
      Content-Type: application/json
      Accept: application/json
    body_format: json
    body:
      userid: "SKLMAdmin"
      password: "{{ scale_encryption_admin_password }}"
    validate_certs: no
  register: login_response

- name: Extract UserAuthId from login response
  set_fact:
    user_auth_id: "{{ login_response.json.UserAuthId }}"  

- name: "************************ Encryption | Master Replication | Configuring ************************"
  uri:
    url: "https://{{ scale_encryption_servers[0] }}:9443/SKLM/rest/v1/replicationConfigProperties"
    method: PUT
    headers:
      Content-Type: "application/json"
      Authorization: "SKLMAuth userAuthId={{ user_auth_id }}"
    body_format: json
    body:
      replication.role: "master"
      backup.EncryptionPassword: "{{ scale_encryption_admin_password }}"
      backup.TLSCertAlias: "{{ scale_cluster_clustername }}"
      backup.ClientIP1: "{{ server }}"
      backup.ClientPort1: "2222"
      replication.MasterListenPort: "1111"
      backup.CheckFrequency: "60"
      replication.Incremental.Enable: "true"
      replication.Incremental.CheckFrequency: "600"
    validate_certs: no
  register: master_replication_response

- debug:
     var: master_replication_response.json
