---

- name: Collect the hosts
  hosts: all
  become: no
  tasks:
    - name: Get the node classes
      command: mmlsnodeclass
      register: node_class_output
      changed_when: false
      run_once: true

    - name: Extract and create list for x86 hosts
      set_fact:
          scale_io_nodes_list: "{{ ( (node_class_output.stdout | regex_search(node_class_name, '\\1') | first ) | default('')).split()  }}"
      vars:
          node_class_name: '(?m)^ess3500_x86_64\s+([\s\S]*?)(?=\n\S|\Z)'
      register: io_node_collection
      run_once: true

    - debug:
        var: io_node_collection
      run_once: true
    
    - name: Get utility node
      command: ssh -G utilitybaremetal | grep hostname
      register: utility_collection_output
      changed_when: false
      run_once: true

    - name: Extract and create list for utility node
      set_fact:
          scale_utility_nodes_list: "{{ ( (utility_collection_output.stdout | regex_search(key, '\\1') | first ) | default('')).split()  }}"
      vars:
          key: '(?m)hostname\s+([\s\S]*?)(?=\n\S|\Z)'
      register: utility_node_collection
      run_once: true

    - debug:
        var: utility_node_collection
      run_once: true

    - name: Add io nodes to hosts
      add_host:
        name: "{{ item }}"
        groups: ionodes
      loop: "{{scale_io_nodes_list}}"

    - name: Add utility nodes to hosts
      add_host:
        name: "{{ item }}"
        groups: utilitynode
      loop: "{{scale_utility_nodes_list}}"


- hosts: all
  become: no

  vars:
    tpm_password_file: "/root/tpm_pwd"
    disable_clear: true
    nv_slot_count: 1
    nv_slot_id: "0x1500001"
    generate: true
    migrate: true
    enroll_drive: true
    rekey_drive: false
    recovery_group: "rg1"

  roles:
    - sed_configure